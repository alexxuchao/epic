<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPIC - E-commerce Product Image Evaluator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .drag-active { border-color: #3B82F6; background-color: #EFF6FF; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useCallback, useRef } = React;

        // Evaluation dimension descriptions
        const evaluationDimensions = {
            quality: {
                title: "Visual Quality",
                description: "Professional appearance, lighting, composition, and clarity",
                criteria: [
                    "Is the product clearly visible and in focus?",
                    "Is the lighting professional without harsh shadows?",
                    "Does the composition follow design principles?",
                    "Is the image sharp and high-resolution?"
                ]
            },
            brand: {
                title: "Brand Consistency",
                description: "Alignment with brand guidelines and campaign objectives",
                criteria: [
                    "Does it match the brand's visual style?",
                    "Is the context appropriate for the brand positioning?",
                    "Does it support the campaign goals?",
                    "Would the target audience connect with this image?"
                ]
            },
            technical: {
                title: "Technical Compliance",
                description: "Image quality, format requirements, and AI artifact detection",
                criteria: [
                    "Does it meet resolution requirements?",
                    "Are there any visible AI artifacts or distortions?",
                    "Is the product accurately represented?",
                    "Are colors and details properly rendered?"
                ]
            }
        };

        // Helper function to resize image for API limits
        async function resizeImageForAPI(dataUrl, maxWidth = 2048, maxHeight = 2048) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    
                    // Calculate new dimensions
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }
                    
                    // Create canvas and resize
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Return resized image as data URL
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = dataUrl;
            });
        }

        // Fallback mock evaluation for when real API fails
        function mockEvaluateImage(imageFile, brandInfo, campaignGoal) {
            const qualityBase = 3.0 + (Math.random() * 2.0);
            const brandBase = 3.0 + (Math.random() * 2.0);
            const technical = Math.random() > 0.15 ? "pass" : "fail";
            
            const quality = Math.min(5, Math.max(1, qualityBase));
            const brand = Math.min(5, Math.max(1, brandBase));
            const overall = (quality + brand) / 2;
            
            let status;
            if (technical === "pass" && overall >= 3.5) {
                status = "approved";
            } else if (overall >= 3.0) {
                status = "needs_review";
            } else {
                status = "rejected";
            }
            
            return {
                quality: Math.round(quality * 10) / 10,
                brand: Math.round(brand * 10) / 10,
                technical: technical,
                overall: Math.round(overall * 10) / 10,
                status: status,
                rationale: {
                    quality: `[MOCK] Image shows ${quality >= 4 ? 'excellent' : quality >= 3 ? 'good' : 'poor'} lighting and composition with ${quality >= 4 ? 'sharp' : 'adequate'} details.`,
                    brand: `[MOCK] Brand consistency is ${brand >= 4 ? 'excellent' : brand >= 3 ? 'good' : 'weak'} with appropriate styling for the target market.`,
                    technical: `[MOCK] ${technical === 'pass' ? 'No significant technical issues detected' : 'Some technical issues found such as artifacts or resolution problems'}.`
                }
            };
        }
        async function evaluateImageWithLLM(imageDataUrl, brandInfo, campaignGoal, apiKey) {
            if (!apiKey) {
                throw new Error('API key is required for LLM evaluation');
            }

            // Validate API key format
            if (!apiKey.startsWith('sk-')) {
                throw new Error('Invalid API key format. OpenAI API keys start with "sk-"');
            }

            try {
                // Resize image if needed for API limits
                const resizedImageUrl = await resizeImageForAPI(imageDataUrl);
                
                const prompt = `You are an expert e-commerce image evaluator. Evaluate this AI-generated product image across three dimensions:

1. QUALITY (1-5): Assess lighting, composition, clarity, professional appearance
2. BRAND (1-5): Evaluate consistency with brand: "${brandInfo || 'general e-commerce brand'}" and campaign goal: "${campaignGoal || 'product showcase'}"
3. TECHNICAL: Check for AI artifacts, distortions, resolution issues (pass/fail)

Provide your evaluation in this exact JSON format:
{
    "quality": <score>,
    "brand": <score>,
    "technical": "pass" or "fail",
    "overall": <average of quality and brand>,
    "status": "approved" (if overall >= 3.5 and technical pass), "needs_review" (if overall 3-3.4), or "rejected",
    "rationale": {
        "quality": "<detailed explanation>",
        "brand": "<detailed explanation>",
        "technical": "<detailed explanation>"
    }
}`;

                console.log('Making API request to OpenAI...');
                
                const requestBody = {
                    model: 'gpt-4o', // Updated model name
                    messages: [
                        {
                            role: 'user',
                            content: [
                                { type: 'text', text: prompt },
                                { 
                                    type: 'image_url', 
                                    image_url: { 
                                        url: resizedImageUrl,
                                        detail: 'high'
                                    } 
                                }
                            ]
                        }
                    ],
                    max_tokens: 500,
                    temperature: 0.1
                };

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey.trim()}`
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    let errorMessage;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error?.message || `HTTP ${response.status}`;
                        console.error('API Error Details:', errorData);
                        
                        // Specific error handling
                        if (response.status === 401) {
                            throw new Error('Invalid API key. Please check your OpenAI API key.');
                        } else if (response.status === 429) {
                            throw new Error('Rate limit exceeded. Please wait 60 seconds and try again, or upgrade your OpenAI plan for higher limits.');
                        } else if (response.status === 403) {
                            throw new Error('API access forbidden. Check if your API key has GPT-4 vision access.');
                        } else {
                            throw new Error(`API error (${response.status}): ${errorMessage}`);
                        }
                    } catch (parseError) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }
                }

                const data = await response.json();
                console.log('API Response received');
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response structure from OpenAI API');
                }

                let evaluation;
                try {
                    const content = data.choices[0].message.content;
                    console.log('Raw AI response:', content);
                    
                    // Try to extract JSON from the response
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        evaluation = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in AI response');
                    }
                } catch (parseError) {
                    console.error('Failed to parse LLM response:', data.choices[0].message.content);
                    throw new Error(`Failed to parse AI response: ${parseError.message}`);
                }
                
                // Ensure all required fields are present and valid
                return {
                    quality: Number(evaluation.quality) || 3,
                    brand: Number(evaluation.brand) || 3,
                    technical: evaluation.technical === 'pass' ? 'pass' : 'fail',
                    overall: Number(evaluation.overall) || ((Number(evaluation.quality) + Number(evaluation.brand)) / 2),
                    status: evaluation.status || 'needs_review',
                    rationale: evaluation.rationale || {
                        quality: 'Unable to analyze quality',
                        brand: 'Unable to analyze brand consistency',
                        technical: 'Unable to analyze technical aspects'
                    }
                };
            } catch (error) {
                console.error('LLM evaluation error:', error);
                
                // Check for CORS error
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    throw new Error('CORS error: Cannot call OpenAI API directly from browser. You need a backend proxy server.');
                }
                
                // Return error status with detailed message
                return {
                    quality: 0,
                    brand: 0,
                    technical: 'fail',
                    overall: 0,
                    status: 'error',
                    rationale: {
                        quality: `Error: ${error.message}`,
                        brand: `Error: ${error.message}`,
                        technical: `Error: ${error.message}`
                    }
                };
            }
        }

        function App() {
            const [currentPage, setCurrentPage] = useState('landing');
            const [sourceImage, setSourceImage] = useState(null);
            const [generatedImages, setGeneratedImages] = useState([]);
            const [outputSize, setOutputSize] = useState('1080x1080');
            const [brandInfo, setBrandInfo] = useState('');
            const [campaignGoal, setCampaignGoal] = useState('');
            const [apiKey, setApiKey] = useState('');
            const [evaluationResults, setEvaluationResults] = useState([]);
            const [isEvaluating, setIsEvaluating] = useState(false);

            const handleFileUpload = (files, type) => {
                const fileArray = Array.from(files);
                
                if (type === 'source' && fileArray.length > 0) {
                    const file = fileArray[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setSourceImage({
                            file: file,
                            preview: e.target.result,
                            name: file.name
                        });
                    };
                    reader.readAsDataURL(file);
                } else if (type === 'generated') {
                    const remainingSlots = 8 - generatedImages.length;
                    const filesToProcess = fileArray.slice(0, remainingSlots);
                    
                    let processedImages = [];
                    let processedCount = 0;
                    
                    filesToProcess.forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            processedImages.push({
                                id: `img_${Date.now()}_${index}`,
                                file: file,
                                preview: e.target.result,
                                name: file.name
                            });
                            
                            processedCount++;
                            if (processedCount === filesToProcess.length) {
                                setGeneratedImages(prev => [...prev, ...processedImages]);
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                }
            };

            const removeGeneratedImage = (imageId) => {
                setGeneratedImages(prev => prev.filter(img => img.id !== imageId));
            };

            const runEvaluation = async () => {
                setIsEvaluating(true);
                setCurrentPage('evaluation');
                
                // Initialize results array with all placeholders
                const placeholders = generatedImages.map(img => ({
                    ...img,
                    aiEvaluation: null,
                    humanEvaluation: null
                }));
                setEvaluationResults(placeholders);
                
                // Track if we're using mock due to API issues
                let usingMock = false;
                let apiErrorMessage = null;
                
                // Evaluate each image one by one
                for (let i = 0; i < generatedImages.length; i++) {
                    // Add delay to avoid rate limiting
                    if (i > 0) {
                        const delay = Math.min(5000 + (i * 2000), 15000); // 5s, 7s, 9s... up to 15s max
                        console.log(`Waiting ${delay/1000} seconds before next evaluation...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                    
                    let evaluation;
                    
                    // Try real API first, fallback to mock if it fails
                    try {
                        evaluation = await evaluateImageWithLLM(
                            generatedImages[i].preview,
                            brandInfo,
                            campaignGoal,
                            apiKey
                        );
                        
                        // Check if the evaluation returned an error status
                        if (evaluation.status === 'error') {
                            throw new Error(evaluation.rationale.quality);
                        }
                        
                    } catch (error) {
                        console.warn(`API evaluation failed for image ${i + 1}:`, error.message);
                        
                        // Check for CORS or other browser-blocking issues
                        if (error.message.includes('CORS') || 
                            error.message.includes('fetch') || 
                            error.message.includes('NetworkError') ||
                            !usingMock) {
                            
                            apiErrorMessage = error.message;
                            usingMock = true;
                            console.log('Falling back to mock evaluation due to API issues');
                        }
                        
                        // Use mock evaluation as fallback
                        evaluation = mockEvaluateImage(generatedImages[i].file, brandInfo, campaignGoal);
                        evaluation.usedMock = true;
                        evaluation.apiError = error.message;
                    }
                    
                    // Update just this specific image in the results array
                    setEvaluationResults(prev => prev.map((item, index) => 
                        index === i 
                            ? { 
                                ...item, 
                                aiEvaluation: {
                                    ...evaluation,
                                    evaluatedAt: new Date(),
                                    usingMock: usingMock
                                }
                            }
                            : item
                    ));
                }
                
                // Show notification if we fell back to mock
                if (usingMock) {
                    console.warn('Used mock evaluation due to API issues:', apiErrorMessage);
                }
                
                setIsEvaluating(false);
            };

            const updateHumanEvaluation = (imageId, newEvaluation) => {
                setEvaluationResults(prev => 
                    prev.map(img => 
                        img.id === imageId 
                            ? { 
                                ...img, 
                                humanEvaluation: { 
                                    ...img.humanEvaluation, 
                                    ...newEvaluation, 
                                    evaluatedAt: new Date() 
                                } 
                            }
                            : img
                    )
                );
            };

            const exportResults = () => {
                const exportData = {
                    evaluation_id: `eval_${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    source_image: sourceImage?.name,
                    configuration: {
                        outputSize,
                        brandInfo,
                        campaignGoal,
                        llmModel: 'gpt-4-vision-preview'
                    },
                    results: evaluationResults.map(img => ({
                        image: img.name,
                        ai_scores: {
                            quality: img.aiEvaluation?.quality,
                            brand: img.aiEvaluation?.brand,
                            technical: img.aiEvaluation?.technical,
                            overall: img.aiEvaluation?.overall,
                            status: img.aiEvaluation?.status
                        },
                        ai_rationale: img.aiEvaluation?.rationale,
                        human_evaluation: img.humanEvaluation
                    }))
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `evaluation_${Date.now()}.json`;
                a.click();
            };

            // Determine if evaluation can proceed - can now work without API key (mock fallback)
            const canEvaluate = sourceImage && generatedImages.length === 8;

            if (currentPage === 'landing') {
                return <LandingPage onStart={() => setCurrentPage('upload')} />;
            } else if (currentPage === 'upload') {
                return (
                    <UploadPage 
                        onFileUpload={handleFileUpload}
                        sourceImage={sourceImage}
                        setSourceImage={setSourceImage}
                        generatedImages={generatedImages}
                        setGeneratedImages={setGeneratedImages}
                        outputSize={outputSize}
                        setOutputSize={setOutputSize}
                        brandInfo={brandInfo}
                        setBrandInfo={setBrandInfo}
                        campaignGoal={campaignGoal}
                        setCampaignGoal={setCampaignGoal}
                        apiKey={apiKey}
                        setApiKey={setApiKey}
                        evaluationDimensions={evaluationDimensions}
                        onEvaluate={runEvaluation}
                        canEvaluate={canEvaluate}
                        removeGeneratedImage={removeGeneratedImage}
                    />
                );
            } else if (currentPage === 'evaluation') {
                return (
                    <EvaluationPage
                        sourceImage={sourceImage}
                        evaluationResults={evaluationResults}
                        isEvaluating={isEvaluating}
                        onHumanEvaluation={updateHumanEvaluation}
                        onExport={exportResults}
                        onNewEvaluation={() => {
                            setSourceImage(null);
                            setGeneratedImages([]);
                            setEvaluationResults([]);
                            setCurrentPage('upload');
                        }}
                        evaluationDimensions={evaluationDimensions}
                    />
                );
            }
        }

        function LandingPage({ onStart }) {
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <div className="max-w-4xl text-center">
                        {/* Problem Statement */}
                        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <h2 className="text-lg font-semibold text-red-800 mb-2">The Enterprise Challenge</h2>
                            <p className="text-red-700 text-sm">
                                E-commerce companies generate thousands of AI product images daily but struggle with <strong>quality control at scale</strong>. 
                                Manual review is slow, inconsistent, and expensive. Poor-quality images reaching customers damage brand reputation and sales.
                            </p>
                        </div>

                        <h1 className="text-5xl font-bold text-gray-900 mb-4">
                            EPIC: E-commerce Product Image Evaluator
                        </h1>
                        <p className="text-xl text-gray-600 mb-6">
                            AI-powered quality control using GPT-4 Vision as an automated evaluation jury
                        </p>

                        <div className="bg-white rounded-lg shadow-lg p-8 mb-8">
                            <h2 className="text-2xl font-semibold mb-6">Evaluation Methodology: LLM as Expert Judge</h2>
                            
                            {/* Evaluation Criteria Showcase */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-left mb-6">
                                <div className="border border-blue-200 rounded-lg p-4">
                                    <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-3">
                                        <span className="text-2xl">⭐</span>
                                    </div>
                                    <h3 className="font-semibold mb-2 text-blue-800">Visual Quality (1-5)</h3>
                                    <p className="text-sm text-gray-600">Professional lighting, composition, clarity, and overall aesthetic appeal</p>
                                    <p className="text-xs text-blue-600 mt-2"><strong>AI evaluates:</strong> Focus, shadows, resolution, framing</p>
                                </div>
                                <div className="border border-green-200 rounded-lg p-4">
                                    <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-3">
                                        <span className="text-2xl">🎯</span>
                                    </div>
                                    <h3 className="font-semibold mb-2 text-green-800">Brand Consistency (1-5)</h3>
                                    <p className="text-sm text-gray-600">Alignment with brand guidelines, style, and campaign objectives</p>
                                    <p className="text-xs text-green-600 mt-2"><strong>AI evaluates:</strong> Style match, target audience fit, positioning</p>
                                </div>
                                <div className="border border-orange-200 rounded-lg p-4">
                                    <div className="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mb-3">
                                        <span className="text-2xl">🔧</span>
                                    </div>
                                    <h3 className="font-semibold mb-2 text-orange-800">Technical Compliance</h3>
                                    <p className="text-sm text-gray-600">AI artifact detection, resolution check, distortion analysis</p>
                                    <p className="text-xs text-orange-600 mt-2"><strong>AI evaluates:</strong> Artifacts, distortions, technical quality</p>
                                </div>
                            </div>

                            {/* Workflow */}
                            <h3 className="text-lg font-semibold mb-4">Evaluation Workflow</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-left">
                                <div className="text-center">
                                    <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <span className="text-xl">📤</span>
                                    </div>
                                    <h4 className="font-semibold mb-2">1. Upload</h4>
                                    <p className="text-sm text-gray-600">Source + 8 AI-generated images</p>
                                </div>
                                <div className="text-center">
                                    <div className="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <span className="text-xl">🤖</span>
                                    </div>
                                    <h4 className="font-semibold mb-2">2. AI Judge</h4>
                                    <p className="text-sm text-gray-600">GPT-4V evaluates each image</p>
                                </div>
                                <div className="text-center">
                                    <div className="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <span className="text-xl">👤</span>
                                    </div>
                                    <h4 className="font-semibold mb-2">3. Human Review</h4>
                                    <p className="text-sm text-gray-600">Validate AI decisions, add feedback</p>
                                </div>
                                <div className="text-center">
                                    <div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <span className="text-xl">📊</span>
                                    </div>
                                    <h4 className="font-semibold mb-2">4. Export</h4>
                                    <p className="text-sm text-gray-600">Production-ready results + insights</p>
                                </div>
                            </div>
                        </div>

                        <button
                            onClick={onStart}
                            className="bg-blue-600 text-white px-8 py-4 rounded-lg text-lg font-semibold hover:bg-blue-700 transition shadow-lg"
                        >
                            Start AI Image Evaluation Demo
                        </button>
                        
                        <p className="text-sm text-gray-500 mt-4">
                            <strong>Time to complete:</strong> 3-5 minutes | <strong>Cost:</strong> ~$0.05 with your OpenAI API key
                        </p>
                    </div>
                </div>
            );
        }

        function UploadPage({ onFileUpload, sourceImage, setSourceImage, generatedImages, setGeneratedImages, outputSize, setOutputSize, brandInfo, setBrandInfo, campaignGoal, setCampaignGoal, apiKey, setApiKey, evaluationDimensions, onEvaluate, canEvaluate, removeGeneratedImage }) {
            const [sourceDragActive, setSourceDragActive] = useState(false);
            const [generatedDragActive, setGeneratedDragActive] = useState(false);

            const handleDrag = (e, setActive, isDisabled = false) => {
                e.preventDefault();
                e.stopPropagation();
                if (!isDisabled) {
                    if (e.type === "dragenter" || e.type === "dragover") {
                        setActive(true);
                    } else if (e.type === "dragleave") {
                        setActive(false);
                    }
                }
            };

            const handleDrop = (e, type, setActive, isDisabled = false) => {
                e.preventDefault();
                e.stopPropagation();
                setActive(false);
                
                if (!isDisabled && e.dataTransfer.files && e.dataTransfer.files[0]) {
                    onFileUpload(e.dataTransfer.files, type);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-6xl mx-auto">
                        {/* Enhanced Header with Context */}
                        <div className="bg-white rounded-lg shadow p-6 mb-8">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900">Upload Images for AI Evaluation</h1>
                                    <p className="text-gray-600 mt-2">
                                        Demonstrate enterprise-scale quality control using GPT-4 Vision as an automated evaluation jury
                                    </p>
                                </div>
                                <div className="text-right">
                                    <div className="text-sm text-gray-500">Micro-Task Demo</div>
                                    <div className="text-lg font-semibold text-blue-600">Batch Image Evaluation</div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            {/* Source Image Upload */}
                            <div>
                                <h2 className="text-lg font-semibold mb-3">Source Product Image</h2>
                                <div
                                    className={`border-2 border-dashed rounded-lg p-8 text-center transition ${
                                        sourceDragActive ? 'drag-active' : 'border-gray-300'
                                    }`}
                                    onDragEnter={(e) => handleDrag(e, setSourceDragActive, false)}
                                    onDragLeave={(e) => handleDrag(e, setSourceDragActive, false)}
                                    onDragOver={(e) => handleDrag(e, setSourceDragActive, false)}
                                    onDrop={(e) => handleDrop(e, 'source', setSourceDragActive, false)}
                                >
                                    {sourceImage ? (
                                        <div className="relative">
                                            <img src={sourceImage.preview} alt="Source" className="w-32 h-32 object-cover mx-auto mb-4 rounded" />
                                            <p className="text-sm text-gray-600 mb-2">{sourceImage.name}</p>
                                            <button
                                                onClick={() => setSourceImage(null)}
                                                className="text-sm text-red-600 hover:underline"
                                            >
                                                Replace image
                                            </button>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center mx-auto mb-4">
                                                <span className="text-2xl">📷</span>
                                            </div>
                                            <p className="text-gray-600 mb-2">Drop your source product image here</p>
                                            <input
                                                type="file"
                                                accept="image/*"
                                                onChange={(e) => onFileUpload(e.target.files, 'source')}
                                                className="hidden"
                                                id="source-upload"
                                            />
                                            <label htmlFor="source-upload" className="text-blue-600 cursor-pointer hover:underline">
                                                or browse
                                            </label>
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* Generated Images Upload */}
                            <div>
                                <div className="flex justify-between items-center mb-3">
                                    <h2 className="text-lg font-semibold">AI-Generated Campaign Images (8 required)</h2>
                                    {generatedImages.length > 0 && (
                                        <button
                                            onClick={() => setGeneratedImages([])}
                                            className="text-sm text-red-600 hover:underline"
                                        >
                                            Clear all
                                        </button>
                                    )}
                                </div>
                                <div
                                    className={`border-2 border-dashed rounded-lg p-8 text-center transition ${
                                        generatedDragActive ? 'drag-active' : 'border-gray-300'
                                    } ${generatedImages.length === 8 ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    onDragEnter={(e) => handleDrag(e, setGeneratedDragActive, generatedImages.length === 8)}
                                    onDragLeave={(e) => handleDrag(e, setGeneratedDragActive, generatedImages.length === 8)}
                                    onDragOver={(e) => handleDrag(e, setGeneratedDragActive, generatedImages.length === 8)}
                                    onDrop={(e) => handleDrop(e, 'generated', setGeneratedDragActive, generatedImages.length === 8)}
                                >
                                    {generatedImages.length === 8 ? (
                                        <p className="text-gray-400">All 8 images uploaded. Remove images to add different ones.</p>
                                    ) : generatedImages.length > 0 ? (
                                        <div>
                                            <div className="grid grid-cols-4 gap-2 mb-4">
                                                {generatedImages.map((img, idx) => (
                                                    <div key={img.id} className="relative group">
                                                        <img src={img.preview} alt={`Generated ${idx + 1}`} className="w-full h-16 object-cover rounded" />
                                                        <button
                                                            onClick={() => removeGeneratedImage(img.id)}
                                                            className="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 text-xs opacity-0 group-hover:opacity-100 transition"
                                                        >
                                                            ×
                                                        </button>
                                                    </div>
                                                ))}
                                                {Array.from({ length: 8 - generatedImages.length }).map((_, idx) => (
                                                    <div key={`empty-${idx}`} className="w-full h-16 border-2 border-dashed border-gray-300 rounded flex items-center justify-center text-gray-400 text-xs">
                                                        {idx + generatedImages.length + 1}
                                                    </div>
                                                ))}
                                            </div>
                                            <p className="text-sm text-gray-600 mb-2">{generatedImages.length}/8 images uploaded</p>
                                            {generatedImages.length < 8 ? (
                                                <>
                                                    <p className="text-sm text-gray-500 mb-2">Add more images ({8 - generatedImages.length} slots remaining)</p>
                                                    <input
                                                        type="file"
                                                        accept="image/*"
                                                        multiple
                                                        onChange={(e) => onFileUpload(e.target.files, 'generated')}
                                                        className="hidden"
                                                        id="generated-upload-more"
                                                    />
                                                    <label htmlFor="generated-upload-more" className="text-blue-600 cursor-pointer hover:underline">
                                                        Add more images
                                                    </label>
                                                </>
                                            ) : (
                                                <p className="text-sm text-green-600 font-medium">✓ All 8 images uploaded</p>
                                            )}
                                        </div>
                                    ) : (
                                        <>
                                            <div className="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center mx-auto mb-4">
                                                <span className="text-2xl">🎨</span>
                                            </div>
                                            <p className="text-gray-600 mb-2">Drop AI-generated campaign images (up to 8)</p>
                                            <p className="text-sm text-gray-500 mb-2">You can add images one at a time or multiple at once</p>
                                            <input
                                                type="file"
                                                accept="image/*"
                                                multiple
                                                onChange={(e) => onFileUpload(e.target.files, 'generated')}
                                                className="hidden"
                                                id="generated-upload"
                                            />
                                            <label htmlFor="generated-upload" className="text-blue-600 cursor-pointer hover:underline">
                                                or browse
                                            </label>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Configuration */}
                        <div className="bg-white rounded-lg shadow p-6 mb-8">
                            <h2 className="text-lg font-semibold mb-4">Configuration</h2>
                            
                            {/* LLM Configuration */}
                            <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                <h3 className="font-medium mb-3">GPT-4V Evaluation Settings</h3>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        OpenAI API Key <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value)}
                                        placeholder="sk-... (or leave empty to use mock evaluation)"
                                        className="w-full p-2 border border-gray-300 rounded-lg font-mono text-sm"
                                    />
                                </div>
                                
                                <div className="text-xs text-gray-600 space-y-1">
                                    <p>
                                        Get your OpenAI API key at <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">platform.openai.com</a>
                                    </p>
                                    <p className="text-green-600">
                                        ✅ <strong>No API key?</strong> Leave empty to use intelligent mock evaluation for demo purposes
                                    </p>
                                    <p className="text-orange-600">
                                        ⚠️ Cost: ~$0.03-0.05 per evaluation (8 images total) with real API
                                    </p>
                                    <p className="text-blue-600">
                                        ℹ️ Rate Limits: Progressive delays (5s, 7s, 9s...) + automatic retry with exponential backoff
                                    </p>
                                    <p className="text-green-600">
                                        ✅ Evaluation takes ~2-3 minutes total (includes delays to avoid 429 errors)
                                    </p>
                                    <p className="text-red-600">
                                        ⚠️ Note: Direct browser API calls may be blocked by CORS. For production, use a backend proxy.
                                    </p>
                                    <p>Your API key is used locally and never stored.</p>
                                </div>
                            </div>

                            {/* Evaluation Dimensions */}
                            <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h3 className="font-medium mb-3">GPT-4V Evaluation Dimensions</h3>
                                <div className="space-y-3 text-sm">
                                    <div>
                                        <h4 className="font-medium text-gray-700">{evaluationDimensions.quality.title} (1-5)</h4>
                                        <p className="text-gray-600">{evaluationDimensions.quality.description}</p>
                                    </div>
                                    <div>
                                        <h4 className="font-medium text-gray-700">{evaluationDimensions.brand.title} (1-5)</h4>
                                        <p className="text-gray-600">{evaluationDimensions.brand.description}</p>
                                    </div>
                                    <div>
                                        <h4 className="font-medium text-gray-700">{evaluationDimensions.technical.title} (Pass/Fail)</h4>
                                        <p className="text-gray-600">{evaluationDimensions.technical.description}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Output Size</label>
                                    <select
                                        value={outputSize}
                                        onChange={(e) => setOutputSize(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg"
                                    >
                                        <option value="1080x1080">Instagram Square (1080x1080)</option>
                                        <option value="1080x1920">Instagram Story (1080x1920)</option>
                                        <option value="2000x2000">Amazon Main (2000x2000)</option>
                                        <option value="1920x600">Website Banner (1920x600)</option>
                                    </select>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Brand Information <span className="text-gray-400">(optional)</span>
                                    </label>
                                    <input
                                        type="text"
                                        value={brandInfo}
                                        onChange={(e) => setBrandInfo(e.target.value)}
                                        placeholder="e.g., Premium eco-friendly brand, minimalist aesthetic"
                                        className="w-full p-2 border border-gray-300 rounded-lg"
                                    />
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Campaign Goal <span className="text-gray-400">(optional)</span>
                                    </label>
                                    <textarea
                                        value={campaignGoal}
                                        onChange={(e) => setCampaignGoal(e.target.value)}
                                        placeholder="e.g., Showcase sustainability features, appeal to young professionals, highlight premium quality"
                                        className="w-full p-2 border border-gray-300 rounded-lg"
                                        rows="2"
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Evaluate Button */}
                        <div className="text-center">
                            <button
                                onClick={onEvaluate}
                                disabled={!canEvaluate}
                                className={`px-8 py-3 rounded-lg font-semibold transition ${
                                    canEvaluate
                                        ? 'bg-blue-600 text-white hover:bg-blue-700'
                                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                }`}
                            >
                                Evaluate Images
                            </button>
                            {!canEvaluate && (
                                <p className="text-sm text-gray-500 mt-2">
                                    {!sourceImage && generatedImages.length === 0 && "Please upload 1 source image and exactly 8 generated images"}
                                    {!sourceImage && generatedImages.length > 0 && "Please upload a source image"}
                                    {sourceImage && generatedImages.length < 8 && `Please upload ${8 - generatedImages.length} more generated image${8 - generatedImages.length > 1 ? 's' : ''}`}
                                </p>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function EvaluationPage({ sourceImage, evaluationResults, isEvaluating, onHumanEvaluation, onExport, onNewEvaluation, evaluationDimensions }) {
            const [selectedImage, setSelectedImage] = useState(null);

            // Get the current version of selected image from evaluationResults (to show real-time updates)
            const currentSelectedImage = selectedImage ? 
                evaluationResults.find(img => img.id === selectedImage.id) || selectedImage 
                : null;

            const getStatusColor = (status) => {
                switch (status) {
                    case 'approved': return 'bg-green-100 text-green-800';
                    case 'needs_review': return 'bg-yellow-100 text-yellow-800';
                    case 'rejected': return 'bg-red-100 text-red-800';
                    case 'error': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            const getScoreColor = (score) => {
                if (score >= 4) return 'text-green-600';
                if (score >= 3) return 'text-yellow-600';
                return 'text-red-600';
            };

            const validResults = evaluationResults.filter(r => r.aiEvaluation);
            const stats = {
                autoApproved: validResults.filter(r => r.aiEvaluation?.status === 'approved').length,
                humanApproved: validResults.filter(r => r.humanEvaluation?.status === 'approved').length,
                rejected: validResults.filter(r => r.humanEvaluation?.status === 'rejected' || (!r.humanEvaluation && r.aiEvaluation?.status === 'rejected')).length,
                errors: validResults.filter(r => r.aiEvaluation?.status === 'error').length,
                avgQuality: validResults.length > 0 ? validResults.reduce((sum, r) => sum + (r.aiEvaluation?.quality || 0), 0) / validResults.length : 0
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-7xl mx-auto">
                        {/* Evaluation Framework */}
                        <div className="bg-white rounded-lg shadow p-6 mb-6">
                            <h2 className="text-xl font-bold text-blue-800 mb-4">Evaluation Dimensions</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="border border-blue-200 rounded-lg p-4">
                                    <h3 className="font-semibold text-blue-700 mb-2">📸 Quality (1-5)</h3>
                                    <p className="text-sm text-gray-600 mb-2">Professional appearance drives conversion</p>
                                    <div className="bg-blue-50 p-2 rounded text-xs">
                                        <strong className="text-blue-800">Impact:</strong> 67% higher conversion rates with professional images
                                    </div>
                                </div>
                                <div className="border border-green-200 rounded-lg p-4">
                                    <h3 className="font-semibold text-green-700 mb-2">🎯 Brand Consistency (1-5)</h3>
                                    <p className="text-sm text-gray-600 mb-2">Maintains customer trust and recognition</p>
                                    <div className="bg-green-50 p-2 rounded text-xs">
                                        <strong className="text-green-800">Impact:</strong> Off-brand images reduce customer trust by 31%
                                    </div>
                                </div>
                                <div className="border border-orange-200 rounded-lg p-4">
                                    <h3 className="font-semibold text-orange-700 mb-2">🔧 Technical (Pass/Fail)</h3>
                                    <p className="text-sm text-gray-600 mb-2">Prevents costly returns and exchanges</p>
                                    <div className="bg-orange-50 p-2 rounded text-xs">
                                        <strong className="text-orange-800">Impact:</strong> Poor resolution increases returns by 15%
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Visual Examples */}
                        <div className="bg-white rounded-lg shadow p-6 mb-6">
                            <h2 className="text-xl font-bold text-purple-800 mb-4">What Our AI Evaluates: Good vs. Poor Examples</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="border-2 border-green-300 rounded-lg p-4">
                                    <h3 className="font-semibold text-green-700 mb-2 flex items-center">
                                        ✅ High-Quality Example
                                    </h3>
                                    <div className="bg-green-50 p-3 rounded mb-3">
                                        <div className="w-full h-32 bg-gradient-to-br from-green-100 to-green-200 rounded flex items-center justify-center text-green-600 text-sm">
                                            [Professional product photo with clean lighting]
                                        </div>
                                    </div>
                                    <ul className="text-sm text-green-700 space-y-1">
                                        <li>• Professional, even lighting</li>
                                        <li>• Clear, undistorted product</li>
                                        <li>• On-brand context and styling</li>
                                        <li>• High resolution, no artifacts</li>
                                    </ul>
                                </div>
                                <div className="border-2 border-red-300 rounded-lg p-4">
                                    <h3 className="font-semibold text-red-700 mb-2 flex items-center">
                                        ❌ Low-Quality Example
                                    </h3>
                                    <div className="bg-red-50 p-3 rounded mb-3">
                                        <div className="w-full h-32 bg-gradient-to-br from-red-100 to-red-200 rounded flex items-center justify-center text-red-600 text-sm">
                                            [Poor quality image with obvious flaws]
                                        </div>
                                    </div>
                                    <ul className="text-sm text-red-700 space-y-1">
                                        <li>• Harsh shadows, poor lighting</li>
                                        <li>• Product distortion or blur</li>
                                        <li>• Generic, off-brand background</li>
                                        <li>• Visible AI artifacts</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-between items-start mb-8">
                            <div>
                                <h1 className="text-3xl font-bold text-gray-900">AI Evaluation Results</h1>
                                <p className="text-gray-600 mt-2">
                                    GPT-4 Vision analyzed each image across Quality, Brand, and Technical dimensions
                                </p>
                                
                                {/* Enhanced Progress Indicator */}
                                {isEvaluating && (
                                    <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-medium text-blue-800">
                                                Evaluation Progress: {evaluationResults.filter(r => r.aiEvaluation).length}/{evaluationResults.length} images
                                            </span>
                                            <span className="text-xs text-blue-600">
                                                ~{Math.max(0, (evaluationResults.length - evaluationResults.filter(r => r.aiEvaluation).length) * 7)} seconds remaining
                                            </span>
                                        </div>
                                        <div className="w-full bg-blue-200 rounded-full h-2">
                                            <div 
                                                className="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                                style={{ width: `${(evaluationResults.filter(r => r.aiEvaluation).length / evaluationResults.length) * 100}%` }}
                                            ></div>
                                        </div>
                                        {evaluationResults.filter(r => r.aiEvaluation).length < evaluationResults.length && (
                                            <p className="text-xs text-blue-600 mt-2">
                                                Currently evaluating image {evaluationResults.filter(r => r.aiEvaluation).length + 1}...
                                            </p>
                                        )}
                                    </div>
                                )}
                                
                                <div className="flex items-center gap-4 mt-3">
                                    {evaluationResults.length > 0 && evaluationResults[0]?.aiEvaluation?.usingMock ? (
                                        <span className="text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full">
                                            Using Mock Evaluation (API Issue)
                                        </span>
                                    ) : (
                                        <span className="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                                            Using GPT-4 Vision
                                        </span>
                                    )}
                                    <span className="text-xs text-green-600 font-medium">
                                        Enterprise Quality Control Demo
                                    </span>
                                </div>
                            </div>
                            <div className="space-x-4">
                                <button
                                    onClick={onExport}
                                    className="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                                    disabled={isEvaluating}
                                >
                                    📊 Export Analytics
                                </button>
                                <button
                                    onClick={onNewEvaluation}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                >
                                    🔄 New Evaluation
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                            {/* Image Grid */}
                            <div className="lg:col-span-3">
                                <div className="grid grid-cols-3 gap-4">
                                    {/* Source Image */}
                                    <div className="bg-white rounded-lg shadow p-4">
                                        <div className="relative">
                                            <img
                                                src={sourceImage?.preview}
                                                alt="Source"
                                                className="w-full h-48 object-cover rounded"
                                            />
                                            <span className="absolute top-2 left-2 bg-gray-800 text-white px-2 py-1 rounded text-xs">
                                                ORIGINAL
                                            </span>
                                        </div>
                                    </div>

                                    {/* Generated Images */}
                                    {evaluationResults.map((result, idx) => (
                                        <div key={result.id} className="bg-white rounded-lg shadow p-4 relative">
                                            <div className="relative">
                                                <img
                                                    src={result.preview}
                                                    alt={`Generated ${idx + 1}`}
                                                    className="w-full h-48 object-cover rounded cursor-pointer"
                                                    onClick={() => setSelectedImage(result)}
                                                />
                                                {isEvaluating && !result.aiEvaluation ? (
                                                    <div className="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center rounded">
                                                        <div className="text-center">
                                                            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                                                            <p className="text-xs text-gray-600">GPT-4V</p>
                                                        </div>
                                                    </div>
                                                ) : result.aiEvaluation && (
                                                    <>
                                                        <div className="group">
                                                            <span className={`absolute top-2 right-2 px-2 py-1 rounded text-xs cursor-help ${getStatusColor(result.aiEvaluation.status)}`}>
                                                                {result.aiEvaluation.status === 'error' ? 'ERROR' : result.aiEvaluation.status.replace('_', ' ').toUpperCase()}
                                                            </span>
                                                            <div className="absolute top-10 right-2 w-48 bg-gray-800 text-white text-xs rounded p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                                                {result.aiEvaluation.status === 'approved' && 'Image meets all quality standards'}
                                                                {result.aiEvaluation.status === 'needs_review' && 'Quality is borderline, human review recommended'}
                                                                {result.aiEvaluation.status === 'rejected' && 'Image fails quality or technical requirements'}
                                                                {result.aiEvaluation.status === 'error' && 'Evaluation failed - check error message'}
                                                            </div>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                            
                                            {result.aiEvaluation && (
                                                <div className="mt-3 space-y-2">
                                                    <div className="flex justify-between text-sm group relative">
                                                        <span className="cursor-help">Quality:</span>
                                                        <span className={getScoreColor(result.aiEvaluation.quality)}>
                                                            {result.aiEvaluation.quality}/5
                                                        </span>
                                                        <div className="absolute left-0 bottom-full mb-2 w-48 bg-gray-800 text-white text-xs rounded p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                                            {evaluationDimensions.quality.description}
                                                        </div>
                                                    </div>
                                                    <div className="flex justify-between text-sm group relative">
                                                        <span className="cursor-help">Brand:</span>
                                                        <span className={getScoreColor(result.aiEvaluation.brand)}>
                                                            {result.aiEvaluation.brand}/5
                                                        </span>
                                                        <div className="absolute left-0 bottom-full mb-2 w-48 bg-gray-800 text-white text-xs rounded p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                                            {evaluationDimensions.brand.description}
                                                        </div>
                                                    </div>
                                                    <div className="flex justify-between text-sm group relative">
                                                        <span className="cursor-help">Technical:</span>
                                                        <span className={result.aiEvaluation.technical === 'pass' ? 'text-green-600' : 'text-red-600'}>
                                                            {result.aiEvaluation.technical.toUpperCase()}
                                                        </span>
                                                        <div className="absolute left-0 bottom-full mb-2 w-48 bg-gray-800 text-white text-xs rounded p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                                            {evaluationDimensions.technical.description}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Human Evaluation Buttons */}
                                                    <div className="pt-2 border-t flex gap-2">
                                                        <button
                                                            onClick={() => onHumanEvaluation(result.id, { status: 'approved' })}
                                                            className={`flex-1 p-1 rounded text-xs ${
                                                                result.humanEvaluation?.status === 'approved'
                                                                    ? 'bg-green-600 text-white'
                                                                    : 'bg-gray-100 hover:bg-gray-200'
                                                            }`}
                                                            title="Approve"
                                                        >
                                                            ✅
                                                        </button>
                                                        <button
                                                            onClick={() => onHumanEvaluation(result.id, { status: 'rejected' })}
                                                            className={`flex-1 p-1 rounded text-xs ${
                                                                result.humanEvaluation?.status === 'rejected'
                                                                    ? 'bg-red-600 text-white'
                                                                    : 'bg-gray-100 hover:bg-gray-200'
                                                            }`}
                                                            title="Reject"
                                                        >
                                                            ❌
                                                        </button>
                                                        <button
                                                            onClick={() => onHumanEvaluation(result.id, { status: 'flagged' })}
                                                            className={`flex-1 p-1 rounded text-xs ${
                                                                result.humanEvaluation?.status === 'flagged'
                                                                    ? 'bg-yellow-600 text-white'
                                                                    : 'bg-gray-100 hover:bg-gray-200'
                                                            }`}
                                                            title="Flag for Review"
                                                        >
                                                            ⚠️
                                                        </button>
                                                        <button
                                                            onClick={() => setSelectedImage(result)}
                                                            className={`flex-1 p-1 rounded text-xs ${
                                                                result.humanEvaluation?.comments 
                                                                    ? 'bg-blue-600 text-white' 
                                                                    : 'bg-blue-100 hover:bg-blue-200 text-blue-600'
                                                            }`}
                                                            title={result.humanEvaluation?.comments ? 'Has Comments - View Details' : 'Add Comments & Details'}
                                                        >
                                                            {result.humanEvaluation?.comments ? '💬' : '🔍'}
                                                        </button>
                                                    </div>
                                                    
                                                    {/* Comment indicator */}
                                                    {result.humanEvaluation?.comments && (
                                                        <div className="mt-1 text-xs text-blue-600 text-center">
                                                            Has feedback
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="lg:col-span-1">
                                <div className="bg-white rounded-lg shadow p-6 sticky top-4">
                                    <div className="text-center mb-4 p-3 bg-blue-50 rounded-lg">
                                        <h2 className="text-lg font-semibold text-blue-800">Enterprise Impact Demo</h2>
                                        <p className="text-xs text-blue-600 mt-1">Automated quality control at scale</p>
                                    </div>
                                    
                                    <h3 className="text-md font-semibold mb-4">Evaluation Statistics</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <p className="text-sm text-gray-600">Auto-approved by AI</p>
                                            <p className="text-2xl font-bold text-green-600">{stats.autoApproved}/8</p>
                                            <p className="text-xs text-green-500">Ready for production</p>
                                        </div>
                                        <div>
                                            <p className="text-sm text-gray-600">Human approved</p>
                                            <p className="text-2xl font-bold text-blue-600">{stats.humanApproved}/8</p>
                                            <p className="text-xs text-blue-500">Human validated</p>
                                        </div>
                                        <div>
                                            <p className="text-sm text-gray-600">Rejected</p>
                                            <p className="text-2xl font-bold text-red-600">{stats.rejected}/8</p>
                                            <p className="text-xs text-red-500">Quality issues detected</p>
                                        </div>
                                        <div>
                                            <p className="text-sm text-gray-600">Average AI quality score</p>
                                            <p className="text-2xl font-bold">{stats.avgQuality.toFixed(1)}/5</p>
                                            <p className="text-xs text-gray-500">Consistent standards</p>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-6 pt-6 border-t">
                                        <h3 className="font-semibold mb-3 text-purple-800">AI Judge Insights</h3>
                                        <ul className="space-y-2 text-sm text-gray-600">
                                            {stats.errors > 0 && (
                                                <li className="text-red-600">• {stats.errors} evaluation errors occurred - check API key and connection</li>
                                            )}
                                            {stats.avgQuality < 3.5 && stats.errors === 0 && (
                                                <li>• <strong>Recommendation:</strong> Adjust AI generation prompts for better quality</li>
                                            )}
                                            {stats.rejected > 4 && stats.errors === 0 && (
                                                <li>• <strong>Alert:</strong> High rejection rate - review generation settings</li>
                                            )}
                                            {stats.autoApproved > 6 && stats.errors === 0 && (
                                                <li>• <strong>Success:</strong> Excellent AI performance - maintain current settings</li>
                                            )}
                                            {stats.errors === 0 && (
                                                <li>• <strong>Pattern:</strong> Background style performing well across batch</li>
                                            )}
                                        </ul>
                                    </div>
                                    
                                    <div className="mt-6 pt-6 border-t">
                                        <h3 className="font-semibold mb-3 text-green-800">Enterprise Value</h3>
                                        <div className="space-y-3 text-xs text-gray-600">
                                            <div className="bg-green-50 p-2 rounded">
                                                <p><span className="font-medium text-green-700">Time Saved:</span> Manual review of 8 images: ~20 minutes → AI review: ~3 minutes</p>
                                            </div>
                                            <div className="bg-blue-50 p-2 rounded">
                                                <p><span className="font-medium text-blue-700">Consistency:</span> Same evaluation criteria applied to every image</p>
                                            </div>
                                            <div className="bg-purple-50 p-2 rounded">
                                                <p><span className="font-medium text-purple-700">Scalability:</span> Can process thousands of images with identical standards</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-6 pt-6 border-t">
                                        <h3 className="font-semibold mb-3">Evaluation Criteria</h3>
                                        <div className="space-y-2 text-xs text-gray-600">
                                            <p><span className="font-medium">Quality:</span> Professional appearance, lighting, clarity</p>
                                            <p><span className="font-medium">Brand:</span> Consistency with brand guidelines</p>
                                            <p><span className="font-medium">Technical:</span> Resolution, AI artifacts check</p>
                                            <p className="pt-2 text-blue-600">Click 🔍 to see detailed GPT-4V reasoning</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Image Detail Modal with Real-time Updates */}
                    {currentSelectedImage && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={() => setSelectedImage(null)}>
                            <div className="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                <div className="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-start">
                                    <h3 className="text-lg font-semibold">Image Details & Human Evaluation</h3>
                                    <button onClick={() => setSelectedImage(null)} className="text-gray-500 hover:text-gray-700 text-xl">
                                        ✕
                                    </button>
                                </div>
                                
                                <div className="p-6">
                                    <img src={currentSelectedImage.preview} alt="Detail" className="w-full max-h-96 object-contain mb-6 rounded" />
                                    
                                    {/* AI Evaluation with Rationale */}
                                    <div className="mb-8">
                                        <div className="flex items-center justify-between mb-3">
                                            <h4 className="font-semibold">
                                                {currentSelectedImage.aiEvaluation?.usingMock ? 'Mock Evaluation (API Failed)' : 'GPT-4 Vision Evaluation'}
                                            </h4>
                                            {currentSelectedImage.aiEvaluation?.usingMock && (
                                                <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                                                    FALLBACK
                                                </span>
                                            )}
                                        </div>
                                        
                                        {currentSelectedImage.aiEvaluation?.apiError && (
                                            <div className="bg-red-50 border border-red-200 rounded p-3 mb-4">
                                                <p className="text-sm text-red-800">
                                                    <strong>API Error:</strong> {currentSelectedImage.aiEvaluation.apiError}
                                                </p>
                                                <p className="text-xs text-red-600 mt-1">
                                                    Using mock evaluation as fallback. For real GPT-4V evaluation, try using a backend proxy to avoid CORS issues.
                                                </p>
                                            </div>
                                        )}
                                    
                                        <div className="space-y-4">
                                            <div className="bg-gray-50 p-4 rounded">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <span className="font-medium">{evaluationDimensions.quality.title}:</span>
                                                        <p className="text-xs text-gray-500 mt-1">{evaluationDimensions.quality.description}</p>
                                                    </div>
                                                    <span className={`font-bold ${getScoreColor(currentSelectedImage.aiEvaluation?.quality)}`}>
                                                        {currentSelectedImage.aiEvaluation?.quality}/5
                                                    </span>
                                                </div>
                                                <p className="text-sm text-gray-600 italic mt-2">
                                                    "{currentSelectedImage.aiEvaluation?.rationale?.quality}"
                                                </p>
                                            </div>
                                            
                                            <div className="bg-gray-50 p-4 rounded">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <span className="font-medium">{evaluationDimensions.brand.title}:</span>
                                                        <p className="text-xs text-gray-500 mt-1">{evaluationDimensions.brand.description}</p>
                                                    </div>
                                                    <span className={`font-bold ${getScoreColor(currentSelectedImage.aiEvaluation?.brand)}`}>
                                                        {currentSelectedImage.aiEvaluation?.brand}/5
                                                    </span>
                                                </div>
                                                <p className="text-sm text-gray-600 italic mt-2">
                                                    "{currentSelectedImage.aiEvaluation?.rationale?.brand}"
                                                </p>
                                            </div>
                                            
                                            <div className="bg-gray-50 p-4 rounded">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <span className="font-medium">{evaluationDimensions.technical.title}:</span>
                                                        <p className="text-xs text-gray-500 mt-1">{evaluationDimensions.technical.description}</p>
                                                    </div>
                                                    <span className={`font-bold ${currentSelectedImage.aiEvaluation?.technical === 'pass' ? 'text-green-600' : 'text-red-600'}`}>
                                                        {currentSelectedImage.aiEvaluation?.technical?.toUpperCase()}
                                                    </span>
                                                </div>
                                                <p className="text-sm text-gray-600 italic mt-2">
                                                    "{currentSelectedImage.aiEvaluation?.rationale?.technical}"
                                                </p>
                                            </div>
                                            
                                            <div className="pt-2 border-t">
                                                <div className="flex justify-between">
                                                    <span className="font-medium">Overall Score:</span>
                                                    <span className="font-bold">{currentSelectedImage.aiEvaluation?.overall}/5</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="font-medium">Status:</span>
                                                    <span className={`px-2 py-1 rounded text-xs ${getStatusColor(currentSelectedImage.aiEvaluation?.status)}`}>
                                                        {currentSelectedImage.aiEvaluation?.status?.replace('_', ' ').toUpperCase()}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Enhanced Human Evaluation with Real-time Updates */}
                                    <div className="border-t pt-6">
                                        <h4 className="font-semibold mb-4">Human Evaluation & Feedback</h4>
                                        
                                        <div className="space-y-4">
                                            {/* Quality Rating */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Quality Rating</label>
                                                <select 
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    onChange={(e) => {
                                                        e.stopPropagation();
                                                        console.log('Rating changed to:', e.target.value);
                                                        const rating = parseInt(e.target.value);
                                                        if (rating) {
                                                            onHumanEvaluation(currentSelectedImage.id, { rating });
                                                        }
                                                    }}
                                                    value={currentSelectedImage.humanEvaluation?.rating || ''}
                                                    onClick={(e) => e.stopPropagation()}
                                                >
                                                    <option value="">Select rating...</option>
                                                    <option value="5">5 - Excellent (Ready for production)</option>
                                                    <option value="4">4 - Good (Minor tweaks needed)</option>
                                                    <option value="3">3 - Acceptable (Some issues to address)</option>
                                                    <option value="2">2 - Poor (Major problems)</option>
                                                    <option value="1">1 - Unusable (Complete reject)</option>
                                                </select>
                                                {currentSelectedImage.humanEvaluation?.rating && (
                                                    <p className="text-xs text-green-600 mt-1">✓ Rating saved: {currentSelectedImage.humanEvaluation.rating}/5</p>
                                                )}
                                            </div>
                                            
                                            {/* Issue Tags */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Issues Detected (select all that apply)</label>
                                                <div className="grid grid-cols-2 gap-3">
                                                    {[
                                                        { key: 'product_distorted', label: 'Product distorted' },
                                                        { key: 'off_brand_style', label: 'Off-brand style' },
                                                        { key: 'poor_lighting', label: 'Poor lighting' },
                                                        { key: 'ai_artifacts', label: 'AI artifacts visible' },
                                                        { key: 'wrong_background', label: 'Wrong background' },
                                                        { key: 'text_logo_issues', label: 'Text/Logo issues' },
                                                        { key: 'color_issues', label: 'Color problems' },
                                                        { key: 'composition_issues', label: 'Composition issues' }
                                                    ].map(issue => (
                                                        <label key={issue.key} className="flex items-center text-sm cursor-pointer" onClick={(e) => e.stopPropagation()}>
                                                            <input
                                                                type="checkbox"
                                                                className="mr-2 cursor-pointer"
                                                                checked={currentSelectedImage.humanEvaluation?.issues?.includes(issue.key) || false}
                                                                onChange={(e) => {
                                                                    e.stopPropagation();
                                                                    console.log('Checkbox changed:', issue.key, e.target.checked);
                                                                    const currentIssues = currentSelectedImage.humanEvaluation?.issues || [];
                                                                    const newIssues = e.target.checked 
                                                                        ? [...currentIssues, issue.key]
                                                                        : currentIssues.filter(i => i !== issue.key);
                                                                    onHumanEvaluation(currentSelectedImage.id, { issues: newIssues });
                                                                }}
                                                                onClick={(e) => e.stopPropagation()}
                                                            />
                                                            <span className="cursor-pointer">{issue.label}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                                {currentSelectedImage.humanEvaluation?.issues && currentSelectedImage.humanEvaluation.issues.length > 0 && (
                                                    <p className="text-xs text-green-600 mt-2">✓ {currentSelectedImage.humanEvaluation.issues.length} issue(s) selected</p>
                                                )}
                                            </div>
                                            
                                            {/* Comments */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Detailed Comments & Feedback
                                                </label>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    placeholder="Add detailed feedback, suggestions for improvement, or specific observations about this image..."
                                                    rows="4"
                                                    onChange={(e) => {
                                                        e.stopPropagation();
                                                        console.log('Comments changed:', e.target.value);
                                                        onHumanEvaluation(currentSelectedImage.id, { comments: e.target.value });
                                                    }}
                                                    value={currentSelectedImage.humanEvaluation?.comments || ''}
                                                    onClick={(e) => e.stopPropagation()}
                                                    onFocus={(e) => e.stopPropagation()}
                                                />
                                                {currentSelectedImage.humanEvaluation?.comments && (
                                                    <p className="text-xs text-green-600 mt-1">✓ {currentSelectedImage.humanEvaluation.comments.length} characters entered</p>
                                                )}
                                                <p className="text-xs text-gray-500 mt-1">
                                                    This feedback will be included in the exported results to help improve future AI generations.
                                                </p>
                                            </div>
                                            
                                            {/* Action Buttons */}
                                            <div className="flex gap-3 pt-4 border-t">
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        onHumanEvaluation(currentSelectedImage.id, { status: 'approved' });
                                                        setSelectedImage(null);
                                                    }}
                                                    className="flex-1 bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 font-medium"
                                                >
                                                    ✅ Approve & Close
                                                </button>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        onHumanEvaluation(currentSelectedImage.id, { status: 'flagged' });
                                                        setSelectedImage(null);
                                                    }}
                                                    className="flex-1 bg-yellow-600 text-white p-3 rounded-lg hover:bg-yellow-700 font-medium"
                                                >
                                                    ⚠️ Flag for Review
                                                </button>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        onHumanEvaluation(currentSelectedImage.id, { status: 'rejected' });
                                                        setSelectedImage(null);
                                                    }}
                                                    className="flex-1 bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 font-medium"
                                                >
                                                    ❌ Reject & Close
                                                </button>
                                            </div>
                                            
                                            {/* Save without closing */}
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    // Force a re-render to show the updated data has been saved
                                                    const currentEval = currentSelectedImage.humanEvaluation || {};
                                                    onHumanEvaluation(currentSelectedImage.id, currentEval);
                                                }}
                                                className="w-full bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-700 text-sm mt-2"
                                            >
                                                💾 Save Feedback (Keep Open)
                                            </button>
                                            
                                            {/* Show saved status with real-time updates */}
                                            {currentSelectedImage.humanEvaluation && (
                                                <div className="mt-3 p-3 bg-blue-50 rounded text-sm border border-blue-200">
                                                    <h5 className="font-medium text-blue-800 mb-2">Current Evaluation Status:</h5>
                                                    <div className="space-y-1">
                                                        <p className="text-blue-700">
                                                            <strong>Status:</strong> {currentSelectedImage.humanEvaluation.status || 'In progress'}
                                                        </p>
                                                        {currentSelectedImage.humanEvaluation.rating && (
                                                            <p className="text-blue-700">
                                                                <strong>Rating:</strong> {currentSelectedImage.humanEvaluation.rating}/5 stars
                                                            </p>
                                                        )}
                                                        {currentSelectedImage.humanEvaluation.issues && currentSelectedImage.humanEvaluation.issues.length > 0 && (
                                                            <p className="text-blue-700">
                                                                <strong>Issues:</strong> {currentSelectedImage.humanEvaluation.issues.join(', ')}
                                                            </p>
                                                        )}
                                                        {currentSelectedImage.humanEvaluation.comments && (
                                                            <p className="text-blue-700">
                                                                <strong>Comments:</strong> "{currentSelectedImage.humanEvaluation.comments.substring(0, 100)}{currentSelectedImage.humanEvaluation.comments.length > 100 ? '...' : ''}"
                                                            </p>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>